<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Drift Check | Tools</title>
    <link rel="stylesheet" href="css/main.css">
</head>

<body>

    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Tools</a>

        <div class="card text-center">
            <h1>System Time Accuracy</h1>

            <div class="time-display" id="time">00:00:00</div>
            <div class="date-display" id="date">Loading...</div>

            <div class="offset-info" id="statusBox">
                <span class="offset-label">Drift from Network Time</span>
                <div class="offset-value" id="offsetValue">--</div>
                <div class="offset-desc" id="offsetDesc">Click the button below to start detection</div>
            </div>

            <div class="details mt-4" id="details" style="font-size: 0.8rem; color: var(--text-light);">
                Comparing with worldtimeapi.org
            </div>

            <button class="btn btn--primary w-full mt-4" id="syncBtn" onclick="syncTime()">Check Time Drift</button>
        </div>
    </div>

    <script>
        // 1. Update local clock
        function updateLocalClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;

            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('date').textContent = now.toLocaleDateString('en-US', options);
        }
        setInterval(updateLocalClock, 1000);
        updateLocalClock();

        // 2. Sync Logic
        async function syncTime() {
            const btn = document.getElementById('syncBtn');
            const statusBox = document.getElementById('statusBox');
            const offsetValue = document.getElementById('offsetValue');
            const offsetDesc = document.getElementById('offsetDesc');
            const details = document.getElementById('details');

            btn.disabled = true;
            btn.textContent = "Connecting to server...";
            offsetValue.textContent = "Checking...";
            offsetValue.className = "offset-value";
            offsetDesc.textContent = "Calculating network latency and drift...";

            try {
                const startTime = Date.now();
                const response = await fetch(`https://worldtimeapi.org/api/ip?t=${startTime}`);
                const endTime = Date.now();

                if (!response.ok) throw new Error("Network response error");

                const data = await response.json();
                const rtt = endTime - startTime;
                const serverTime = new Date(data.datetime).getTime();
                const estimatedServerTimeAtEnd = serverTime + (endTime - startTime) / 2;

                const diff = endTime - estimatedServerTimeAtEnd; // Local - Server

                displayResult(diff, rtt);

            } catch (error) {
                console.error(error);
                offsetValue.textContent = "Failed";
                offsetDesc.textContent = "Unable to reach time server. Please check your connection.";
                details.textContent = "Error: " + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "Re-check Accuracy";
            }
        }

        function displayResult(diffMs, rtt) {
            const offsetValue = document.getElementById('offsetValue');
            const offsetDesc = document.getElementById('offsetDesc');
            const details = document.getElementById('details');

            const absDiff = Math.abs(diffMs);
            const isFast = diffMs > 0;

            let diffStr = "";
            let colorClass = "";

            if (absDiff < 100) {
                diffStr = "Highly Accurate";
                colorClass = "accurate";
                offsetDesc.textContent = `Your clock is in sync (drift < 0.1s)`;
            } else {
                if (absDiff >= 1000) {
                    const secs = (absDiff / 1000).toFixed(2);
                    diffStr = `${secs}s ${isFast ? 'Fast' : 'Slow'}`;
                } else {
                    diffStr = `${Math.round(absDiff)}ms ${isFast ? 'Fast' : 'Slow'}`;
                }
                colorClass = isFast ? "fast" : "slow";
                offsetDesc.textContent = `Your system clock is running ${isFast ? 'ahead of' : 'behind'} standard time`;
            }

            offsetValue.textContent = diffStr;
            offsetValue.className = `offset-value ${colorClass}`;
            details.innerHTML = `RTT (Latency): ${rtt}ms | Raw Offset: ${Math.round(diffMs)}ms`;
        }

        setTimeout(syncTime, 1000);
    </script>
</body>

</html>