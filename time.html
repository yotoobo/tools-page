<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统时间误差检测 | Time Drift Check</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #6c757d;
            --accent: #007bff;
            --error: #dc3545;
            --success: #28a745;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: var(--text-sub);
            font-size: 0.9rem;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-link:hover {
            color: var(--accent);
        }

        h1 {
            font-weight: 300;
            color: var(--text-sub);
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .time-display {
            font-size: 4rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
            line-height: 1;
        }

        .date-display {
            font-size: 1.2rem;
            color: var(--text-sub);
            margin-bottom: 40px;
        }

        .offset-info {
            background: rgba(0, 123, 255, 0.05);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(0, 123, 255, 0.1);
            transition: all 0.3s;
        }

        .offset-label {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-bottom: 10px;
            display: block;
        }

        .offset-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .offset-value.fast {
            color: var(--error);
        }

        .offset-value.slow {
            color: #d63384;
            /* Pinkish for slow just to differentiate or use warn color */
        }

        .offset-value.accurate {
            color: var(--success);
        }

        .offset-desc {
            font-size: 0.95rem;
            color: var(--text-sub);
        }

        .sync-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 30px;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);
        }

        .sync-btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 123, 255, 0.3);
        }

        .sync-btn:active {
            transform: translateY(1px);
        }

        .sync-btn:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .details {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #aaa;
        }

        @media (max-width: 480px) {
            .time-display {
                font-size: 3rem;
            }

            .container {
                padding: 30px 20px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <a href="index.html" class="back-link">← 返回</a>

        <h1>系统时间误差检测</h1>

        <div class="time-display" id="time">00:00:00</div>
        <div class="date-display" id="date">Loading...</div>

        <div class="offset-info" id="statusBox">
            <span class="offset-label">与标准时间服务器 (Network Time) 的误差</span>
            <div class="offset-value" id="offsetValue">--</div>
            <div class="offset-desc" id="offsetDesc">点击下方按钮开始检测</div>
        </div>

        <div class="details" id="details">
            使用 worldtimeapi.org API 进行比对
        </div>

        <button class="sync-btn" id="syncBtn" onclick="syncTime()">开始检测误差</button>
    </div>

    <script>
        // 1. Update local clock
        function updateLocalClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;

            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('date').textContent = now.toLocaleDateString('zh-CN', options);
        }
        setInterval(updateLocalClock, 1000);
        updateLocalClock();

        // 2. Sync Logic
        async function syncTime() {
            const btn = document.getElementById('syncBtn');
            const statusBox = document.getElementById('statusBox');
            const offsetValue = document.getElementById('offsetValue');
            const offsetDesc = document.getElementById('offsetDesc');
            const details = document.getElementById('details');

            btn.disabled = true;
            btn.textContent = "正在连接时间服务器...";
            offsetValue.textContent = "检测中...";
            offsetValue.className = "offset-value"; // reset colors
            offsetDesc.textContent = "正在计算网络延迟和时间差...";

            try {
                // To minimize latency impact, we can try multiple times or just once. 
                // Using worldtimeapi.org

                const startTime = Date.now();
                // Adding a random query param to prevent caching
                const response = await fetch(`https://worldtimeapi.org/api/ip?t=${startTime}`);
                const endTime = Date.now();

                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }

                const data = await response.json();

                // RTT (Round Trip Time)
                const rtt = endTime - startTime;
                const latency = Math.floor(rtt / 2);

                // Server time (unixtime is in seconds, datetime includes ms but needs parsing)
                // data.datetime example: "2024-12-27T11:30:00.123456+00:00"
                // Parse server time directly
                const serverTime = new Date(data.datetime).getTime();

                // We estimate that at the moment we received the response (endTime),
                // the actual server time was serverTime + latency (approximately).
                // Note: 'data.datetime' is the time when server PROCESSED the request.
                // So at 'endTime', real time is serverTime + latency (assuming symmetric network delay)

                // However, worldtimeapi returns the time *at processing*.
                // So:
                // Actual Time @ endTime ≈ ServerTimeParsed + Latency

                // Local Time @ endTime (which is just 'endTime' variable)

                // Diff = Local - Actual
                // If Diff > 0: Local is ahead (Fast)
                // If Diff < 0: Local is behind (Slow)

                // Wait, 'serverTime' from API is static from when it was generated by server.
                // It traveled for 'latency' ms to reach us.
                // So real time NOW (at endTime) is serverTime + latency.
                const estimatedServerTimeAtEnd = serverTime + (endTime - startTime) / 2; /* simplified latency */

                const diff = endTime - estimatedServerTimeAtEnd; // Local - Server

                displayResult(diff, rtt);

            } catch (error) {
                console.error(error);
                offsetValue.textContent = "检测失败";
                offsetValue.style.color = "var(--text-sub)";
                offsetDesc.textContent = "无法连接到时间服务器，请检查网络（可能需要科学上网）或稍后再试。";
                details.textContent = "Error: " + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "重新检测";
            }
        }

        function displayResult(diffMs, rtt) {
            const offsetValue = document.getElementById('offsetValue');
            const offsetDesc = document.getElementById('offsetDesc');
            const details = document.getElementById('details');

            const absDiff = Math.abs(diffMs);
            const isFast = diffMs > 0;

            // Format diff
            let diffStr = "";
            let colorClass = "";

            // Allow 500ms of error margin as "Accurate" due to HTTP non-determinism
            if (absDiff < 500) {
                diffStr = "非常准确";
                colorClass = "accurate";
                offsetDesc.textContent = `系统时间与标准时间几乎一致 (误差 < 0.5秒)`;
            } else {
                // convert to seconds if large
                if (absDiff >= 1000) {
                    const secs = (absDiff / 1000).toFixed(2);
                    diffStr = `${isFast ? '快了' : '慢了'} ${secs} 秒`;
                } else {
                    diffStr = `${isFast ? '快了' : '慢了'} ${Math.round(absDiff)} 毫秒`;
                }

                colorClass = isFast ? "fast" : "slow";
                offsetDesc.textContent = `您的系统时钟比标准世界时间${isFast ? '走快' : '走慢'}了`;
            }

            offsetValue.textContent = diffStr;
            offsetValue.className = `offset-value ${colorClass}`;

            details.innerHTML = `RTT (网络往返时延): ${rtt}ms <br> 原始误差值: ${Math.round(diffMs)}ms`;
        }

        // Auto start after 1 second
        setTimeout(syncTime, 1000);
    </script>
</body>

</html>